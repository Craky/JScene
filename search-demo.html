<!doctype html>
<html>
<head>
<script type="text/javascript" src="db.js"></script></script>
<script type="text/javascript" src="index.js"></script></script>
<script type="text/javascript" src="search.js"></script></script>

<!--script type="text/javascript" src="sample-p10.js"></script></script-->
<script type="text/javascript" src="topics.js"></script></script>

</head>
 
<body>
 
<script>

function statsButton(e) {
  console.log("Getting stats...");

  var request = db.transaction(["postings"], "readonly")
    .objectStore("postings")
    .count();

  request.onsuccess = function(e) {
    console.log("Total number of entries: " + e.target.result);
    return;
  }

/*  var transaction = db.transaction(["postings"], "readonly");
  var store = transaction.objectStore("postings");

  var request = store.count();
  request.onsuccess = function(e) {
    console.log("Total number of entries: " + e.target.result);
    return;
  }
*/

  var transaction = db.transaction(["df"], "readonly");
  var store = transaction.objectStore("df");

  var request = store.count();
  request.onsuccess = function(e) {
    console.log("Total number of terms: " + e.target.result);
    return;
  }
}

// IDF

function buildDf(e) {
  var DF = {};
  for (var i=0; i<tweets.length; i++) {
    if (i % 100 == 0 ) console.log("Processed " + i + " documents.");

    var tokens = tokenizeToHistogram(tweets[i].text);
    for (var t in tokens) {
      if (t in DF) {
        DF[t]++;
      } else {
        DF[t] = 1;
      }
    }
  }

  var tuples = [];
  for (var key in DF) tuples.push([key, DF[key]]);

  insert_df(0, tuples);
}

function insert_df(i, tuples) {
  var transaction = db.transaction(["df"],"readwrite");
  var store = transaction.objectStore("df");
  var request = store.add(tuples[i][1], tuples[i][0]);
 
  //console.log(tuples[i][1], tuples[i][0]);
  request.onerror = function(e) {
    console.log("Error", e.target.error.name);
  }

  request.onsuccess = function(e) {
    if (i % 100 == 0 ) console.log("Inserted " + i + " terms.");
    if (i < tuples.length-1) {
      insert_df(i+1, tuples);
    } else {
      console.log("Done! Inserted " + tuples.length + " terms");
    }
  }
}

// http://stackoverflow.com/questions/5199901/how-to-sort-an-associative-array-by-its-values-in-javascript
function print_results(results, k) {
  var tuples = [];

  for (var key in results) tuples.push([key, results[key]]);

  tuples.sort(function(a, b) {
    return a[1] > b[1] ? -1 : (a[1] < b[1] ? 1 :
      a[0] < b[0] ? 1 : -1);
  });

  for (var i = 0; i < k && i<tuples.length; i++) {
    var key = tuples[i][0];
    var value = tuples[i][1];

    console.log(key, value);
  }
}


searcher.setNumDocs(1128929);

// Querying

function searchButton() {
  query_terms = document.querySelector("#query").value.split(" ");

  searcher.search(query_terms, function(results) {
    console.log("Results for: " + query_terms);
    print_results(results, 10);
  });
}

var topicsStart;
function runTopics() {
  topicsStart = new Date().getTime();
  runTopics_helper(0);
}

function runTopics_helper(i) {
  query_terms = topics[i].text.split(" ");
  searcher.search(query_terms, function(results, t) {
    console.log(query_terms + ": " + (new Date().getTime() - t) + "ms");
    //print_results(results, 20);

    if (i < topics.length - 1) {
      runTopics_helper(i+1);
    } else {
      var e = new Date().getTime();
      console.log((i+1) + " topics, total time: " + (e - topicsStart) + "ms");
      console.log("average query latency = " + (e - topicsStart)/(i+1) + "ms");
    }
  });
}

</script>
 
<button id="indexButton">Build Index</button>
<button id="dfButton">Build DF</button>

<button id="statsButton" onclick="statsButton()">Get Stats</button>

<hr/>

<p>
<input type="text" id="query" placeholder="query">
<button id="searchButton" onclick="searchButton()">Search</button></p>

<p>
<button id="runTopics" onclick="runTopics()">Run Topics</button>
</p>

</body>
</html>
 


